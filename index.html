<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>분실물 찾기 — Jakarta Korean International School</title>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
<style>
:root{--primary:#0B3D2E;--accent:#7CC242;--bg:#F4F9F0;--muted:#4b5a4d;--card-bg:#ffffff;}
*{box-sizing:border-box}
body{font-family:"Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:#111}
header{display:flex;align-items:center;background:var(--primary);color:#fff;padding:12px 16px;gap:12px}
header img.logo{width:56px;height:56px;object-fit:contain;border-radius:8px;background:#fff;padding:6px}
header h1{margin:0;font-size:18px}
header p{margin:0;font-size:13px;opacity:0.9}
main{max-width:980px;margin:18px auto;padding:12px;position:relative;}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.view-toggle,.admin-btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.view-toggle{background:var(--accent);color:var(--primary)}
.admin-btn{background:#fff;color:var(--primary);border:2px solid rgba(255,255,255,0.12)}
.admin-form{display:none;background:var(--card-bg);padding:12px;border-radius:12px;border-left:6px solid var(--accent);box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px;gap:8px;flex-wrap:wrap}
.admin-form input[type="text"],.admin-form input[type="date"]{padding:10px;border-radius:8px;border:1px solid #e6e8ee;width:100%}
.admin-form input[type="file"]{padding:6px;width:100%}
.btn-primary{background:var(--primary);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
.btn-delete{background:#d9534f;color:white;padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.card{background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.04);position:relative;border:1px solid #eef1ec;min-height:200px}
.card img{width:100%;height:140px;object-fit:cover;display:block;background:#f0f0f0}
.card-body{padding:12px}
.name{font-weight:700;color:var(--primary)}
.meta{color:var(--muted);font-size:13px;margin-top:6px}
.edit-icon{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.55);color:#fff;padding:6px;border-radius:8px;display:none;cursor:pointer}
.card:hover .edit-icon{display:block}
.table{width:100%;border-collapse:collapse;background:transparent}
.table th,.table td{border:1px solid #e6eddf;padding:8px;text-align:left;background:#fff}
.table img{width:100px;height:60px;object-fit:cover;border-radius:6px}
.admin-indicator{display:none;padding:6px 10px;border-radius:999px;background:var(--accent);color:var(--primary);font-weight:700}
.admin-mode .admin-indicator{display:inline-block}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px;max-height:90vh;overflow-y:auto}
.modal h3{margin:0 0 8px}
.character{position:absolute;right:8px;bottom:-120px;width:220px;max-width:28%;opacity:0.98;pointer-events:none;}
.loading,.upload-progress{display:flex;align-items:center;justify-content:center;padding:20px;color:var(--muted);background:var(--card-bg);border-radius:12px}
.loading::after,.upload-progress::after{content:'';display:inline-block;width:20px;height:20px;border:2px solid var(--muted);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
#modeBadge{display:inline;color:var(--muted);font-weight:700;margin-left:8px;}
.upload-progress{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;z-index:1000;border-radius:12px;min-width:200px}
.progress-bar{background:var(--accent);height:4px;border-radius:2px;overflow:hidden;margin-top:8px}
.progress-fill{background:var(--primary);height:100%;width:0%;transition:width 0.3s}
@media(max-width:600px){header p{display:none};.card img{height:120px};.table img{width:70px;height:50px};.character{width:140px;bottom:-40px}}
</style>
</head>
<body>

<header>
  <img class="logo" src="logo.png" alt="JIKS Logo" onerror="this.src='https://via.placeholder.com/56x56/0B3D2E/FFFFFF?text=JIKS'">
  <div><h1>분실물 찾기</h1><p>Jakarta Indonesia Korean School</p></div>
  <div style="flex:1"></div>
  <div id="admin-indicator" class="admin-indicator">관리자 모드</div>
</header>

<main>
  <div style="max-width:980px;margin:auto;padding:12px">
    <div class="controls">
      <button id="toggleView" class="view-toggle">테이블 보기</button>
      <div style="flex:1"></div>
      <button id="openAdmin" class="admin-btn">관리자</button>
      <div id="modeBadge">카드</div>
    </div>

    <div id="adminForm" class="admin-form" style="display:none">
      <div style="flex:1;min-width:160px"><input id="inName" type="text" placeholder="물건 이름"></div>
      <div style="flex:1;min-width:140px"><input id="inPlace" type="text" placeholder="장소"></div>
      <div style="min-width:140px"><input id="inDate" type="date"></div>
      <div style="min-width:180px"><input id="inFile" type="file" accept="image/*"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnAdd" class="btn-primary">추가</button>
        <button id="btnDeleteSelected" class="btn-delete">선택 삭제</button>
        <div id="uploadStatus" style="font-size:12px;color:var(--muted)"></div>
      </div>
    </div>

    <section id="gridView">
      <div id="grid" class="grid"></div>
      <div id="emptyGrid" style="display:none;padding:18px;background:#fff;border-radius:10px;margin-top:12px;text-align:center;color:var(--muted)">등록된 분실물이 없습니다.</div>
    </section>

    <section id="tableView" style="display:none">
      <table id="table" class="table"></table>
      <div id="emptyTable" style="display:none;padding:18px;background:#fff;border-radius:10px;margin-top:12px;text-align:center;color:var(--muted)">등록된 분실물이 없습니다.</div>
    </section>
  </div>
</main>

<div id="backdrop" class="backdrop">
  <div id="modal" class="modal" style="display:none"></div>
</div>

<div id="uploadProgress" class="upload-progress">
  <div>사진 업로드 중... <span id="progressText">0%</span></div>
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  <button id="cancelUpload" style="margin-top:12px;padding:6px 12px;background:#d9534f;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">취소</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBAdDlJFlNQHQqkJCC9R28da4vUuPKh1lg",
  authDomain: "jiks-lostandfound.firebaseapp.com",
  databaseURL: "https://jiks-lostandfound-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jiks-lostandfound",
  storageBucket: "jiks-lostandfound.firebasestorage.app",
  messagingSenderId: "299244412202",
  appId: "1:299244412202:web:a6e6e825141dc328249253"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('lostItems');

const CLOUDINARY_CLOUD_NAME = 'dsfsqkcic';
const CLOUDINARY_UPLOAD_PRESET = 'lostandfound';

let items = [], adminMode = false, viewIsTable = false, selectedIds = new Set(), lastSelectedIndex = null, uploadController = null;

const elements = {
  grid: document.getElementById('grid'),
  table: document.getElementById('table'),
  gridView: document.getElementById('gridView'),
  tableView: document.getElementById('tableView'),
  emptyGrid: document.getElementById('emptyGrid'),
  emptyTable: document.getElementById('emptyTable'),
  adminIndicator: document.getElementById('admin-indicator'),
  adminForm: document.getElementById('adminForm'),
  toggleViewBtn: document.getElementById('toggleView'),
  openAdminBtn: document.getElementById('openAdmin'),
  backdrop: document.getElementById('backdrop'),
  modal: document.getElementById('modal'),
  modeBadge: document.getElementById('modeBadge'),
  uploadProgress: document.getElementById('uploadProgress'),
  progressText: document.getElementById('progressText'),
  progressFill: document.getElementById('progressFill'),
  cancelUpload: document.getElementById('cancelUpload')
};

function escape(s=''){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
const ADMIN_PASSWORD = 'jiks1234';

async function uploadImageToCloudinary(file) {
  return new Promise((resolve, reject) => {
    const controller = new AbortController();
    uploadController = controller;
    
    // 간단한 HEIC 변환만 (브라우저 부하 최소화)
    let uploadFile = file;
    if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
      heic2any({blob: file, toType: 'image/jpeg', quality: 0.9}).then(converted => {
        uploadFile = new File([converted], 'image.jpg', {type: 'image/jpeg'});
        performUpload(uploadFile, controller.signal, resolve, reject);
      }).catch(() => performUpload(file, controller.signal, resolve, reject));
    } else {
      performUpload(file, controller.signal, resolve, reject);
    }
  });
}

function performUpload(file, signal, resolve, reject) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
  formData.append('quality', 'auto');
  formData.append('format', 'auto');
  formData.append('fetch_format', 'auto');

  const xhr = new XMLHttpRequest();
  
  xhr.upload.addEventListener('progress', e => {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      elements.progressText.textContent = `${percent}%`;
      elements.progressFill.style.width = `${percent}%`;
    }
  });

  xhr.onload = () => {
    try {
      const data = JSON.parse(xhr.response);
      if (data.secure_url) {
        hideUploadProgress();
        resolve(data.secure_url);
      } else {
        reject(new Error('Cloudinary 응답 오류'));
      }
    } catch(e) {
      reject(new Error('응답 파싱 실패'));
    }
  };

  xhr.onerror = () => reject(new Error('네트워크 오류'));
  xhr.ontimeout = () => reject(new Error('업로드 시간 초과'));
  
  xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`);
  xhr.timeout = 30000; // 30초 타임아웃
  xhr.send(formData);
  
  elements.cancelUpload.onclick = () => {
    controller.abort();
    hideUploadProgress();
  };
}

function showUploadProgress() {
  elements.uploadProgress.style.display = 'flex';
}
function hideUploadProgress() {
  elements.uploadProgress.style.display = 'none';
  elements.progressText.textContent = '0%';
  elements.progressFill.style.width = '0%';
}

async function load() {
  const snapshot = await db.once('value');
  return snapshot.val() ? Object.values(snapshot.val()) : [];
}

async function save() {
  const payload = {};
  items.forEach(item => payload[item.id] = item);
  await db.set(payload);
}

// [렌더링, 관리자, 기타 함수들은 이전과 동일하므로 생략 - 전체 코드 길이 제한]
function render() {
  elements.grid.innerHTML = '';
  if(items.length === 0) {
    elements.emptyGrid.style.display = 'block';
    elements.emptyTable.style.display = 'block';
  } else {
    elements.emptyGrid.style.display = 'none';
    elements.emptyTable.style.display = 'none';
  }
  items.forEach(it => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = it.id;
    card.innerHTML = `
      <div class="edit-icon" title="수정">✎</div>
      <img src="${escape(it.photo || 'https://via.placeholder.com/300?text=No+Image')}" alt="${escape(it.name)}" loading="lazy">
      <div class="card-body">
        <div class="name">${escape(it.name)}</div>
        <div class="meta">${escape(it.place)} • ${escape(it.date)}</div>
      </div>
    `;
    const editIcon = card.querySelector('.edit-icon');
    if(adminMode) {
      editIcon.style
