<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>분실물 찾기 — Jakarta Korean International School</title>

<!-- Firebase (DB는 사용) -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-database-compat.js"></script>

<!-- (Firebase Storage script은 남겨도 무해하지만 사용하지 않습니다) -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-storage-compat.js"></script>

<!-- 이미지 처리 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.min.js"></script>

<style>
  :root{
    --primary:#0B3D2E; --accent:#7CC242; --bg:#F4F9F0;
    --muted:#4b5a4d; --card-bg:#ffffff; --radius:10px;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:var(--bg);color:#111}
  header{display:flex;align-items:center;background:var(--primary);color:#fff;padding:12px 16px;gap:12px}
  header img.logo{width:56px;height:56px;object-fit:contain;border-radius:8px;background:#fff;padding:6px}
  header h1{margin:0;font-size:18px}
  header p{margin:0;font-size:13px;opacity:0.9}
  main{max-width:980px;margin:18px auto;padding:12px;position:relative;}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .view-toggle,.admin-btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .view-toggle{background:var(--accent);color:var(--primary)}
  .admin-btn{background:#fff;color:var(--primary);border:2px solid rgba(255,255,255,0.12)}
  .admin-form{display:none;background:var(--card-bg);padding:12px;border-radius:12px;border-left:6px solid var(--accent);box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px;gap:8px;flex-wrap:wrap}
  .admin-form input[type="text"],.admin-form input[type="date"]{padding:10px;border-radius:8px;border:1px solid #e6e8ee;width:100%}
  .admin-form input[type="file"]{padding:6px;width:100%}
  .btn-primary{background:var(--primary);color:white;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .btn-delete{background:#d9534f;color:white;padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
  .card{background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.04);position:relative;border:1px solid #eef1ec;min-height:200px}
  .card img{width:100%;height:140px;object-fit:cover;display:block;background:#f0f0f0;cursor:pointer}
  .card-body{padding:12px}
  .name{font-weight:700;color:var(--primary)}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  .edit-icon{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.55);color:#fff;padding:6px;border-radius:8px;display:none;cursor:pointer}
  .card:hover .edit-icon{display:block}
  .table{width:100%;border-collapse:collapse;background:transparent}
  .table th,.table td{border:1px solid #e6eddf;padding:8px;text-align:left;background:#fff}
  .table img{width:100px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
  .admin-indicator{display:none;padding:6px 10px;border-radius:999px;background:var(--accent);color:var(--primary);font-weight:700}
  .admin-mode .admin-indicator{display:inline-block}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:820px;max-height:90vh;overflow-y:auto}
  .modal h3{margin:0 0 8px}
  .character{position:absolute;right:8px;bottom:-120px;width:220px;max-width:28%;opacity:0.98;pointer-events:none;}
  .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted)}
  .loading::after{content:'';display:inline-block;width:20px;height:20px;border:2px solid var(--muted);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
  #modeBadge{display:none;color:var(--muted);font-weight:700}
  #searchInput{padding:8px 10px;border-radius:8px;border:1px solid #e6eddf;width:220px}
  @media(max-width:600px){header p{display:none};.card img{height:120px};.table img{width:70px;height:50px};.character{width:140px;bottom:-40px}; #searchInput{width:120px}}
</style>
</head>
<body>

<header>
  <img class="logo" src="logo.png" alt="JIKS Logo" onerror="this.src='https://via.placeholder.com/56x56/0B3D2E/FFFFFF?text=JIKS'">
  <div><h1>분실물 찾기</h1><p>Jakarta Indonesia Korean School</p></div>
  <div style="flex:1"></div>
  <div id="admin-indicator" class="admin-indicator">관리자 모드</div>
</header>

<main>
  <div style="max-width:980px;margin:auto;padding:12px">
    <div class="controls">
      <button id="toggleView" class="view-toggle">테이블 보기</button>

      <!-- 검색 입력 추가 -->
      <input id="searchInput" placeholder="검색: 이름/장소/날짜">

      <div style="flex:1"></div>
      <button id="openAdmin" class="admin-btn">관리자</button>
      <div id="modeBadge">보기: 카드</div>
    </div>

    <div id="adminForm" class="admin-form" style="display:none">
      <div style="flex:1;min-width:160px"><input id="inName" type="text" placeholder="물건 이름"></div>
      <div style="flex:1;min-width:140px"><input id="inPlace" type="text" placeholder="장소 (예: 도서관)"></div>
      <div style="min-width:140px"><input id="inDate" type="date"></div>

      <!-- 파일 선택: showOpenFilePicker 우선, 폴백은 숨긴 input -->
      <div style="min-width:180px;display:flex;gap:6px;align-items:center">
        <button id="pickFileBtn" type="button" class="admin-btn">파일 선택</button>
        <span id="fileName" style="font-size:13px;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">(사진 없음)</span>
        <input id="inFile" type="file" accept="image/*" style="display:none">
      </div>

      <div style="display:flex;gap:8px">
        <button id="btnAdd" class="btn-primary">추가</button>
        <button id="btnDeleteSelected" class="btn-delete">선택 삭제</button>
      </div>
    </div>

    <section id="gridView">
      <div id="grid" class="grid"></div>
      <div id="emptyGrid" style="display:none;padding:18px;background:#fff;border-radius:10px;margin-top:12px;text-align:center;color:var(--muted)">등록된 분실물이 없습니다.</div>
    </section>

    <section id="tableView" style="display:none">
      <table id="table" class="table"></table>
      <div id="emptyTable" style="display:none;padding:18px;background:#fff;border-radius:10px;margin-top:12px;text-align:center;color:var(--muted)">등록된 분실물이 없습니다.</div>
    </section>
  </div>
  <img class="character" src="character.png" alt="character" onerror="this.style.display='none'">
</main>

<div id="backdrop" class="backdrop">
  <div id="modal" class="modal" style="display:none"></div>
</div>

<script>
/* -----------------------
   설정
   ----------------------- */

/* Firebase (기존 사용하던 설정 유지) */
const firebaseConfig = {
  apiKey: "AIzaSyBAdDlJFlNQHQqkJCC9R28da4vUuPKh1lg",
  authDomain: "jiks-lostandfound.firebaseapp.com",
  databaseURL: "https://jiks-lostandfound-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jiks-lostandfound",
  storageBucket: "jiks-lostandfound.firebasestorage.app",
  messagingSenderId: "299244412202",
  appId: "1:299244412202:web:a6e6e825141dc328249253"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('lostItems');
// const storage = firebase.storage(); // 더 이상 사용하지 않음 (이미지 저장은 Cloudinary로 변경)

/* Cloudinary 설정 (네가 알려준 값으로 채움) */
const CLOUDINARY_CLOUD_NAME = 'dsfsqkcic';
const CLOUDINARY_UPLOAD_PRESET = 'lostandfound';

/* ---------- 상태 ---------- */
let items = [];
let adminMode = false;
let viewIsTable = false;
let selectedIds = new Set();
let lastSelectedIndex = null;

/* 파일 선택 상태 (custom) */
let selectedFile = null;

/* 검색 상태 */
let searchTerm = '';

/* ---------- 요소 ---------- */
const grid = document.getElementById('grid');
const table = document.getElementById('table');
const gridView = document.getElementById('gridView');
const tableView = document.getElementById('tableView');
const emptyGrid = document.getElementById('emptyGrid');
const emptyTable = document.getElementById('emptyTable');
const adminIndicator = document.getElementById('admin-indicator');
const adminForm = document.getElementById('adminForm');
const toggleViewBtn = document.getElementById('toggleView');
const openAdminBtn = document.getElementById('openAdmin');
const backdrop = document.getElementById('backdrop');
const modal = document.getElementById('modal');
const modeBadge = document.getElementById('modeBadge');
const pickFileBtn = document.getElementById('pickFileBtn');
const fileNameSpan = document.getElementById('fileName');
const hiddenFileInput = document.getElementById('inFile');
const searchInput = document.getElementById('searchInput');

/* ---------- 도우미 ---------- */
function escape(s=''){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
const ADMIN_PASSWORD = 'jiks1234';

/* -----------------------
   Cloudinary 업로드 함수 (HEIC 변환 + 압축 포함)
   반환값: 업로드된 이미지의 secure_url 문자열
   ----------------------- */
async function uploadImageToStorage(file) {
  if (!file) return '';
  try {
    // HEIC -> JPEG 변환 (필요 시)
    let processedFile = file;
    if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
      try {
        const convertedBlob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.8 });
        processedFile = new File([convertedBlob], file.name.replace(/\.[^/.]+$/, '.jpg'), { type: 'image/jpeg' });
      } catch (e) {
        console.warn('HEIC 변환 실패:', e);
      }
    }

    // 이미지 압축
    try {
      const options = { maxSizeMB: 1, maxWidthOrHeight: 800, useWebWorker: true };
      processedFile = await imageCompression(processedFile, options);
    } catch (e) {
      console.warn('압축 실패:', e);
    }

    // Cloudinary unsigned upload
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
    const form = new FormData();
    form.append('file', processedFile);
    form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

    const resp = await fetch(url, { method: 'POST', body: form });
    if (!resp.ok) {
      const text = await resp.text().catch(()=>null);
      throw new Error(`Cloudinary 업로드 실패: ${resp.status} ${resp.statusText} ${text||''}`);
    }
    const data = await resp.json();
    // data.secure_url 에 업로드된 이미지 URL이 들어있음
    return data.secure_url || data.url || '';
  } catch (err) {
    console.error('uploadImageToStorage error:', err);
    throw err;
  }
}

/* -----------------------
   Firebase DB (메타데이터) 처리
   ----------------------- */
async function load() {
  try {
    const snapshot = await db.once('value');
    const data = snapshot.val();
    return data ? Object.values(data) : [];
  } catch(e) {
    console.error('로드 실패:', e);
    return [];
  }
}

async function save() {
  try {
    const data = {};
    items.forEach(it => { data[it.id] = it; });
    await db.set(data);
  } catch(e) {
    console.error('저장 실패:', e);
  }
}

/* ---------- 렌더링 ---------- */
function getFilteredItems() {
  if (!searchTerm) return items.slice();
  const q = searchTerm.trim().toLowerCase();
  return items.filter(it => {
    const name = (it.name || '').toString().toLowerCase();
    const place = (it.place || '').toString().toLowerCase();
    const date = (it.date || '').toString().toLowerCase();
    return name.includes(q) || place.includes(q) || date.includes(q);
  });
}

function render() {
  const displayItems = getFilteredItems();

  grid.innerHTML = '';
  if(displayItems.length === 0) {
    emptyGrid.style.display = 'block';
    emptyTable.style.display = 'block';
  } else {
    emptyGrid.style.display = 'none';
    emptyTable.style.display = 'none';
  }

  displayItems.forEach(it => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = it.id;
    card.innerHTML = `
      <div class="edit-icon" title="수정">✎</div>
      <img src="${escape(it.photo || 'https://via.placeholder.com/800x600?text=No+Image')}" alt="${escape(it.name)}" loading="lazy" onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
      <div class="card-body">
        <div class="name">${escape(it.name)}</div>
        <div class="meta">${escape(it.place)} • ${escape(it.date)}</div>
      </div>
    `;
    
    const editIcon = card.querySelector('.edit-icon');
    if (adminMode) {
      editIcon.style.display = 'block';
      editIcon.addEventListener('click', e => {
        e.stopPropagation();
        openEditModal(it.id);
      });
    }
    
    card.addEventListener('click', e => {
      if (adminMode) selectCard(it.id, e);
      else showDetail(it);
    });

    // 카드 안의 이미지는 클릭 시 항상 사진 모달 열리게 (이미 카드 클릭도 처리하지만 이미지에 따로 이벤트 추가)
    const imgEl = card.querySelector('img');
    imgEl.addEventListener('click', (ev) => {
      ev.stopPropagation(); // 카드의 선택/수정 동작과 분리
      showDetail(it);
    });
    
    if(adminMode) card.classList.add('show-edit');
    card.style.outline = selectedIds.has(it.id) ? '3px solid rgba(124,223,74,0.24)' : 'none';
    grid.appendChild(card);
  });
  renderTable(displayItems);
}

function renderTable(displayItems) {
  // displayItems는 필터된 목록을 기대. 만약 호출 시 인자 없으면 기본 items 사용
  const list = displayItems || getFilteredItems();
  if(list.length === 0) { table.innerHTML = ''; return; }
  let html = `<thead><tr><th>사진</th><th>물건 이름</th><th>장소</th><th>날짜</th>${adminMode?'<th>액션</th>':''}</tr></thead><tbody>`;
  list.forEach(it => {
    // 이미지 클릭으로 전체 보기 가능하도록 onclick 연결
    html += `<tr data-id="${it.id}">
      <td><img src="${escape(it.photo || 'https://via.placeholder.com/400x300?text=No+Image')}" alt="${escape(it.name)}" style="max-width:120px;max-height:80px;object-fit:cover;border-radius:6px" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'" onclick="showDetailById('${it.id}')"></td>
      <td>${escape(it.name)}</td>
      <td>${escape(it.place)}</td>
      <td>${escape(it.date)}</td>
      ${adminMode?`<td><button onclick="openEditModal('${it.id}')" style="font-size:12px;padding:4px 8px;">수정</button> <button onclick="deleteItem('${it.id}')" style="font-size:12px;padding:4px 8px;background:#d9534f;color:white;border:none;border-radius:4px;">삭제</button></td>` : ''}
    </tr>`;
  });
  html += '</tbody>';
  table.innerHTML = html;
}

/* ---------- 선택/상세 ---------- */
function selectCard(id, e) {
  if (!adminMode) return;
  const idx = items.findIndex(x => x.id === id);
  if(idx === -1) return;
  if(e.shiftKey && lastSelectedIndex !== null) {
    const start = Math.min(lastSelectedIndex, idx), end = Math.max(lastSelectedIndex, idx);
    for(let i = start; i <= end; i++) selectedIds.add(items[i].id);
  } else if(e.ctrlKey || e.metaKey) {
    if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
    lastSelectedIndex = idx;
  } else {
    selectedIds.clear();
    selectedIds.add(id);
    lastSelectedIndex = idx;
  }
  document.querySelectorAll('.card').forEach(c => {
    c.style.outline = selectedIds.has(c.dataset.id) ? '3px solid rgba(124,223,74,0.24)' : 'none';
  });
}

function showDetail(it) {
  // 이미지가 화면에 꽉 차게, but 최대 높이 제한(뷰포트)
  modal.innerHTML = `
    <h3>${escape(it.name)}</h3>
    <div style="margin-top:8px;text-align:center">
      <img src="${escape(it.photo||'https://via.placeholder.com/1200x800?text=No+Image')}" style="width:100%;height:auto;max-height:80vh;object-fit:contain;border-radius:8px" loading="lazy" onerror="this.src='https://via.placeholder.com/1200x800?text=No+Image'">
    </div>
    <div style="margin-top:10px;color:var(--muted)">${escape(it.place)} • ${escape(it.date)}</div>
    <div style="margin-top:12px;display:flex;justify-content:space-between;gap:8px;align-items:center">
      <div style="color:var(--muted);font-size:13px">ID: ${escape(it.id)}</div>
      <div style="text-align:right">
        <a href="${escape(it.photo||'')}" target="_blank" rel="noopener noreferrer" style="margin-right:8px;text-decoration:none"><button class="admin-btn" style="padding:8px 12px">원본 보기</button></a>
        <button onclick="closeModal()" class="btn-primary" style="padding:8px 16px">닫기</button>
      </div>
    </div>
  `;
  backdrop.style.display = 'flex'; modal.style.display = 'block';
}

function showDetailById(id) {
  const it = items.find(x => x.id === id);
  if(!it) return;
  showDetail(it);
}

function closeModal() { backdrop.style.display = 'none'; modal.style.display='none'; modal.innerHTML=''; }
backdrop.addEventListener('click', e => { if(e.target === backdrop) closeModal(); });

/* ---------- 관리자 ---------- */
openAdminBtn.addEventListener('click', () => {
  if(!adminMode) {
    modal.innerHTML = `
      <h3>관리자 로그인</h3>
      <input id="pwField" type="password" placeholder="비밀번호" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:16px;margin-top:8px">
      <div style="margin-top:12px;text-align:right">
        <button id="pwCancel" style="padding:8px 16px">취소</button>
        <button id="pwOk" class="btn-primary" style="padding:8px 16px">확인</button>
      </div>
      <div id="pwErr" style="color:#c33;margin-top:8px;display:none;font-weight:500"></div>
    `;
    backdrop.style.display = 'flex'; modal.style.display = 'block';
    document.getElementById('pwCancel').onclick = closeModal;
    document.getElementById('pwOk').onclick = () => {
      const v = document.getElementById('pwField').value.trim();
      if(v === ADMIN_PASSWORD) {
        adminMode = true;
        enterAdmin();
        closeModal();
        alert('관리자 모드 활성화!');
      } else {
        document.getElementById('pwErr').innerHTML = '비밀번호 틀림';
        document.getElementById('pwErr').style.display = 'block';
        document.getElementById('pwField').value = '';
      }
    };
  } else {
    if(confirm('관리자 모드 종료?')) {
      adminMode = false;
      exitAdmin();
      openAdminBtn.textContent = '관리자';
    }
  }
});

function enterAdmin() {
  document.body.classList.add('admin-mode');
  adminIndicator.style.display = 'inline-block';
  adminForm.style.display = 'flex';
  openAdminBtn.textContent = '관리자 종료';
  render();
}

function exitAdmin() {
  document.body.classList.remove('admin-mode');
  adminIndicator.style.display = 'none';
  adminForm.style.display = 'none';
  selectedIds.clear();
  lastSelectedIndex = null;
  selectedFile = null;
  fileNameSpan.textContent = '(사진 없음)';
  render();
}

/* ---------- 파일 선택: showOpenFilePicker 우선, 폴백은 숨긴 input 클릭 ---------- */
pickFileBtn.addEventListener('click', async () => {
  if (window.showOpenFilePicker) {
    try {
      const [handle] = await window.showOpenFilePicker({
        multiple: false,
        types: [{
          description: 'Images',
          accept: {
            'image/*': ['.png', '.jpg', '.jpeg', '.webp', '.heic']
          }
        }]
      });
      const file = await handle.getFile();
      if (file) {
        selectedFile = file;
        fileNameSpan.textContent = file.name;
      }
    } catch (e) {
      hiddenFileInput.click();
    }
  } else {
    hiddenFileInput.click();
  }
});

hiddenFileInput.addEventListener('change', (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (f) {
    selectedFile = f;
    fileNameSpan.textContent = f.name;
  } else {
    selectedFile = null;
    fileNameSpan.textContent = '(사진 없음)';
  }
});

/* ---------- 검색 입력 처리 ---------- */
searchInput.addEventListener('input', (e) => {
  searchTerm = e.target.value || '';
  render();
});

/* ---------- 추가 (Cloudinary 업로드 활용) ---------- */
document.getElementById('btnAdd').addEventListener('click', async () => {
  const name = document.getElementById('inName').value.trim();
  const place = document.getElementById('inPlace').value.trim();
  const date = document.getElementById('inDate').value || new Date().toISOString().split('T')[0];
  
  if(!name) { alert('물건 이름 입력하세요!'); return; }
  
  // selectedFile 우선 사용, 없으면 hidden input 확인
  const file = selectedFile || (document.getElementById('inFile').files[0]);
  let photo = '';
  
  if(file) {
    try {
      grid.innerHTML = '<div class="loading">사진 업로드 중...</div>';
      photo = await uploadImageToStorage(file); // Cloudinary 업로드
    } catch(e) {
      alert('사진 업로드 실패! 콘솔 확인');
      console.error(e);
      grid.innerHTML = '';
      return;
    }
  }
  
  items.unshift({ 
    id: 'item_' + Date.now() + '_' + Math.random().toString(36).slice(2,6), 
    name, place, date, photo, timestamp: Date.now() 
  });
  await save();
  clearAdminInputs();
  render();
  alert('분실물 등록 완료!');
});

function clearAdminInputs() {
  document.getElementById('inName').value = '';
  document.getElementById('inPlace').value = '';
  document.getElementById('inDate').value = '';
  document.getElementById('inFile').value = '';
  selectedFile = null;
  fileNameSpan.textContent = '(사진 없음)';
}

/* ---------- 삭제/수정 ---------- */
document.getElementById('btnDeleteSelected').addEventListener('click', async () => {
  if(!adminMode || selectedIds.size === 0) { alert('관리자 + 선택 필요'); return; }
  if(!confirm(`${selectedIds.size}개 삭제?`)) return;
  items = items.filter(x => !selectedIds.has(x.id));
  selectedIds.clear();
  lastSelectedIndex = null;
  await save();
  render();
});

function deleteItem(id) {
  if(!adminMode) return;
  if(!confirm('삭제?')) return;
  items = items.filter(x => x.id !== id);
  save().then(render);
}

function openEditModal(id) {
  if(!adminMode) return;
  const it = items.find(x => x.id === id);
  if(!it) return;
  
  let editSelectedFile = null;
  
  modal.innerHTML = `
    <h3>항목 수정</h3>
    <input id="eName" type="text" value="${escape(it.name)}" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-top:8px" required>
    <input id="ePlace" type="text" value="${escape(it.place)}" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-top:8px">
    <input id="eDate" type="date" value="${escape(it.date)}" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-top:8px">
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button id="ePickFile" class="admin-btn" type="button">파일 선택</button>
      <span id="eFileName" style="color:var(--muted)">${it.photo ? '기존 사진 있음' : '(사진 없음)'}</span>
      <input id="eFile" type="file" accept="image/*" style="display:none">
    </div>
    <div style="margin-top:16px;text-align:right;gap:8px;display:flex;justify-content:flex-end">
      <button id="cancelEdit" style="padding:8px 16px">취소</button>
      <button id="deleteEdit" class="btn-delete" style="padding:8px 12px">삭제</button>
      <button id="saveEdit" class="btn-primary" style="padding:8px 16px">저장</button>
    </div>
  `;
  backdrop.style.display = 'flex'; modal.style.display = 'block';
  
  const ePick = document.getElementById('ePickFile');
  const eFile = document.getElementById('eFile');
  const eFileName = document.getElementById('eFileName');

  ePick.addEventListener('click', async () => {
    if (window.showOpenFilePicker) {
      try {
        const [handle] = await window.showOpenFilePicker({
          multiple:false,
          types: [{ description: 'Images', accept: {'image/*': ['.png','.jpg','.jpeg','.webp','.heic']} }]
        });
        const f = await handle.getFile();
        if (f) { editSelectedFile = f; eFileName.textContent = f.name; }
      } catch(e) { eFile.click(); }
    } else eFile.click();
  });

  eFile.addEventListener('change', (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (f) { editSelectedFile = f; eFileName.textContent = f.name; }
  });

  document.getElementById('cancelEdit').onclick = closeModal;
  document.getElementById('deleteEdit').onclick = () => {
    if(confirm('삭제?')) {
      items = items.filter(x => x.id !== id);
      save().then(() => { closeModal(); render(); });
    }
  };
  
  document.getElementById('saveEdit').onclick = async () => {
    const n = document.getElementById('eName').value.trim();
    if(!n) { alert('이름 필수'); return; }
    const p = document.getElementById('ePlace').value.trim();
    const d = document.getElementById('eDate').value;
    const f = editSelectedFile;
    
    if(f) {
      try {
        const photoUrl = await uploadImageToStorage(f);
        it.photo = photoUrl;
      } catch(e) {
        alert('사진 업로드 실패');
        return;
      }
    }
    
    it.name = n; it.place = p; it.date = d; it.timestamp = Date.now();
    await save();
    closeModal();
    render();
  };
}

/* ---------- 뷰 전환 (간단하게!) ---------- */
toggleViewBtn.addEventListener('click', () => {
  viewIsTable = !viewIsTable;
  if(viewIsTable) {
    gridView.style.display = 'none'; 
    tableView.style.display = 'block';
    toggleViewBtn.textContent = '카드 보기';
    modeBadge.textContent = '테이블';
  } else {
    gridView.style.display = 'block'; 
    tableView.style.display = 'none';
    toggleViewBtn.textContent = '테이블 보기';
    modeBadge.textContent = '카드';
  }
});

/* ---------- 초기화 ---------- */
async function init() {
  grid.innerHTML = '<div class="loading">데이터 로딩 중...</div>';
  items = await load();
  document.getElementById('inDate').value = new Date().toISOString().split('T')[0];
  gridView.style.display = 'block'; 
  tableView.style.display = 'none';
  modeBadge.textContent = '카드';
  render();
  
  // 실시간 업데이트
  db.on('value', async snapshot => {
    items = snapshot.val() ? Object.values(snapshot.val()) : [];
    render();
  });
}

// 전역 함수
window.openEditModal = openEditModal;
window.deleteItem = deleteItem;
window.closeModal = closeModal;
window.selectCard = selectCard;
window.showDetailById = showDetailById;

init();
</script>
</body>
</html>
